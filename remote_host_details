---                                                                                                                                                                                                                                         
- hosts: all                                                                                                                                                                                                                                
 become: yes                                                                                                                                                                                                                               
 gather_facts: yes                                                                                                                                                                                                                         
 tasks:                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                           
 - name: Get Qualys version                                                                                                                                                                                                                
   ansible.builtin.shell:                                                                                                                                                                                                                  
     cmd: rpm -qa | grep qualys-cloud-agent | cat                                                                                                                                                                                          
   register: get_qualys_version                                                                                                                                                                                                            
 - debug:                                                                                                                                                                                                                                  
     var: get_qualys_version.stdout                                                                                                                                                                                                        
   tags: mytag                                                                                                                                                                                                                             
                                                                                                                                                                                                                                           
 - name: Get CrowdStrike version                                                                                                                                                                                                           
   ansible.builtin.shell:                                                                                                                                                                                                                  
     cmd: rpm -qa | grep wget                                                                                                                                                                                                              
   register: get_crowdstrike_version                                                                                                                                                                                                       
 - debug:                                                                                                                                                                                                                                  
     var: get_crowdstrike_version.stdout                                                                                                                                                                                                   
   tags: mytag                                                                                                                                                                                                                             
                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                           
 - name: CSV - Create file and set the header                                                                                                                                                                                              
   lineinfile:                                                                                                                                                                                                                             
     dest: /home/svcansadm/test.csv                                                                                                                                                                                                        
     #dest: /home/ansadmin/testdir/test.csv                                                                                                                                                                                                
#      dest: "{{ output_path }}/{{ filename }}"                                                                                                                                                                                             
     line:                                                                                                                                                                                                                                 
       Hostname,IP,MachineType,Uptime,OS_Version,Qualys_Version,Crowdstrike_Version                                                                                                                                                        
     create: yes                                                                                                                                                                                                                           
     state: present                                                                                                                                                                                                                        
   delegate_to: localhost                                                                                                                                                                                                                  
                                                                                                                                                                                                                                           
 - name: insert data in csv                                                                                                                                                                                                                
   ansible.builtin.shell: |                                                                                                                                                                                                                
       echo "{{ansible_nodename}} , {{ansible_all_ipv4_addresses[0]}} , {{ansible_product_name}} , {{ now().replace(microsecond=0) - now().fromtimestamp(now(fmt='%s') | int - ansible_uptime_seconds) }} , {{get_qualys_version.stdout}} ,
{{get_crowdstrike_version.stdout}}" >> /home/ansadmin/testdir/test.csv                                                                                                                                                                      
   delegate_to: localhost
